var CABLES=CABLES||{};CABLES.EventTarget=function(){this._eventCallbacks={},this._logName="",this._doLog=!1,this._listeners={},this.addEventListener=this.on=function(e,t,s){const n={id:(s||"")+CABLES.uuid(),name:e,cb:t};return this._eventCallbacks[e]?this._eventCallbacks[e].push(n):this._eventCallbacks[e]=[n],this._listeners[n.id]=n,n.id},this.hasEventListener=function(e,t){if(e&&!t)return!!this._listeners[e];if(console.warn("old eventtarget function haseventlistener!"),e&&t&&this._eventCallbacks[e]){return-1!=this._eventCallbacks[e].indexOf(t)}},this.removeEventListener=this.off=function(e,t){if(null==e)return;if(!t){const t=this._listeners[e];if(!t)return;let s=!0;for(;s;){s=!1;let n=-1;for(let a=0;a<this._eventCallbacks[t.name].length;a++)0===this._eventCallbacks[t.name][a].id.indexOf(e)&&(s=!0,n=a);-1!==n&&(this._eventCallbacks[t.name].splice(n,1),delete this._listeners[e])}return}console.warn("[eventtarget] old function signature: removeEventListener! use listener id");let s=null;for(let n=0;n<this._eventCallbacks[e].length;n++)this._eventCallbacks[e][n].cb==t&&(s=n);null!==s?delete this._eventCallbacks[s]:console.warn("[removeEventListener] not found "+e)},this.logEvents=function(e,t){this._doLog=e,this._logName=t},this.emitEvent=function(e,t,s,n,a,i,r){if(this._doLog&&console.log("[event] ",this._logName,e,this._eventCallbacks),this._eventCallbacks[e])for(let o=0;o<this._eventCallbacks[e].length;o++)this._eventCallbacks[e][o]&&this._eventCallbacks[e][o].cb(t,s,n,a,i,r);else this._doLog&&console.log("[event] has no event callback",e,this._eventCallbacks)}};var TALKER_TYPE="application/x-talkerjs-v1+json",TALKER_ERR_TIMEOUT="timeout",pinkySwearPromise=function(){function e(e){return"function"==typeof e}function t(e){return"object"==typeof e}function s(e){"undefined"!=typeof setImmediate?setImmediate(e):"undefined"!=typeof process&&process.nextTick?process.nextTick(e):setTimeout(e,0)}var n;return function a(){var i,r=[],o=[],h=function(e,t){return null==i&&null!=e&&(i=e,r=t,o.length&&s((function(){for(var e=0;o.length>e;e++)o[e]()}))),i};return h.then=function(h,l){var c=a(),u=function(){try{var s=i?h:l;e(s)?function s(a){var i,r=0;try{if(a&&(t(a)||e(a))&&e(i=a.then)){if(a===c)throw new TypeError;i.call(a,(function(){r++||s.apply(n,arguments)}),(function(e){r++||c(!1,[e])}))}else c(!0,arguments)}catch(e){r++||c(!1,[e])}}(s.apply(n,r||[])):c(i,r)}catch(e){c(!1,[e])}};return null!=i?s(u):o.push(u),c},h}}(),objectCreate=function(e){function t(){}return t.prototype=e,new t},Talker=function(e,t){this.remoteWindow=e,this.remoteOrigin=t,this.timeout=3e3,this.handshaken=!1,this.handshake=pinkySwearPromise(),this._id=0,this._queue=[],this._sent={};var s=this;return window.addEventListener("message",(function(e){s._receiveMessage(e)}),!1),this._sendHandshake(),this};Talker.prototype.send=function(e,t,s){var n=new Talker.OutgoingMessage(this,e,t,s),a=pinkySwearPromise();return this._sent[n.id]=a,this._queue.push(n),this._flushQueue(),setTimeout((function(){a(!1,[new Error(TALKER_ERR_TIMEOUT)])}),this.timeout),a},Talker.prototype._receiveMessage=function(e){var t;try{t=JSON.parse(e.data)}catch(e){t={}}return!!this._isSafeMessage(e.source,e.origin,t.type)&&(t.handshake||t.handshakeConfirmation?this._handleHandshake(t):this._handleMessage(t))},Talker.prototype._isSafeMessage=function(e,t,s){var n,a;return n=e===this.remoteWindow,a="*"===this.remoteOrigin||t===this.remoteOrigin,n&&a&&s===TALKER_TYPE},Talker.prototype._handleHandshake=function(e){e.handshake&&this._sendHandshake(this.handshaken),this.handshaken=!0,this.handshake(!0,[this.handshaken]),this._flushQueue()},Talker.prototype._handleMessage=function(e){var t=new Talker.IncomingMessage(this,e.namespace,e.data,e.id),s=e.responseToId;return s?this._respondToMessage(s,t):this._broadcastMessage(t)},Talker.prototype._respondToMessage=function(e,t){this._sent[e]&&(this._sent[e](!0,[t]),delete this._sent[e])},Talker.prototype._broadcastMessage=function(e){this.onMessage&&this.onMessage.call(this,e)},Talker.prototype._sendHandshake=function(e){var t={type:TALKER_TYPE};t[e?"handshakeConfirmation":"handshake"]=!0,this._postMessage(t)},Talker.prototype._nextId=function(){return this._id+=1},Talker.prototype._postMessage=function(e){this.remoteWindow&&this.remoteOrigin&&this.remoteWindow.postMessage(JSON.stringify(e),this.remoteOrigin)},Talker.prototype._flushQueue=function(){if(this.handshaken){var e=this._queue.shift();if(!e)return this._queue;if(this._postMessage(e),this._queue.length>0)return this._flushQueue()}return this._queue},Talker.Message=function(e,t,s){return this.talker=e,this.namespace=t,this.data=s,this.type=TALKER_TYPE,this},Talker.OutgoingMessage=function(e,t,s,n){Talker.Message.call(this,e,t,s),this.responseToId=n||null,this.id=this.talker._nextId()},Talker.OutgoingMessage.prototype=objectCreate(Talker.Message.prototype),Talker.OutgoingMessage.prototype.constructor=Talker.Message,Talker.OutgoingMessage.prototype.toJSON=function(){return{id:this.id,responseToId:this.responseToId,namespace:this.namespace,data:this.data,type:this.type}},Talker.IncomingMessage=function(e,t,s,n){Talker.Message.call(this,e,t,s),this.id=n},Talker.IncomingMessage.prototype=objectCreate(Talker.Message.prototype),Talker.IncomingMessage.prototype.constructor=Talker.Message,Talker.IncomingMessage.prototype.respond=function(e){return this.talker.send(null,e,this.id)},window.Talker=Talker;var CABLESUILOADER=CABLESUILOADER||{};CABLESUILOADER.TalkerAPI=function(e){CABLES.EventTarget.apply(this),this._talker=new Talker(e,"*"),this._callbackCounter=0,this._callbacks={},this._talker.onMessage=function(e){"callback"==e.data.cmd?this._callbacks[e.data.cb]&&this._callbacks[e.data.cb](e.data.error,e.data.response):this.emitEvent(e.data.cmd,e.data.data,function(t,s){this._talker.send("cables",{cmd:"callback",cb:e.data.cb,response:s,error:t})}.bind(this))}.bind(this)},CABLESUILOADER.TalkerAPI.prototype.send=function(e,t,s){let n={cmd:e,data:t};s&&(this._callbackCounter++,this._callbacks[this._callbackCounter]=s,n.cb=this._callbackCounter),this._talker.send("cables",n)};
//# originalSourceMappingURL=talkerapi.js.map
